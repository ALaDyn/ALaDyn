environment:
    CYGWIN_NOWINPATH: yes
    matrix:
        - cygwin_url: https://cygwin.com/setup-x86_64.exe
          COMPILER: cygwin
        - COMPILER: msys2
          PLATFORM: x64
          MSYS2_ARCH: x86_64
          MSYS2_DIR: msys64
          MSYSTEM: MINGW64
          BIT: 64

install:
  - call "C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\VC\Auxiliary\Build\vcvarsall.bat" x86
  - if [%COMPILER%]==[MSYS2] SET "PATH=C:\%MSYS2_DIR%\%MSYSTEM%\bin;C:\%MSYS2_DIR%\usr\bin;%PATH%"
# Remove C:/Program Files/Git/usr/bin from the path, CMake is incompatible with the sh.exe found inside
  - set PATH=%PATH:C:\Program Files\Git\usr\bin;=%
# Setup pacman (MSYS2 package manager) to enable mirrors and download appropriate toolchain 
  - if [%COMPILER%]==[MSYS2] bash -lc "pacman -S --needed --noconfirm pacman-mirrors"
  - if [%COMPILER%]==[MSYS2] bash -lc "pacman -Syu --noconfirm"
  - if [%COMPILER%]==[MSYS2] bash -lc "pacman -S --needed --noconfirm mingw-w64-x86_64-toolchain make mingw-w64-x86_64-boost"
  - if [%COMPILER%]==[MSYS2] bash -lc "wget http://www.fftw.org/fftw-3.3.6-pl2.tar.gz && tar zxvf fftw-3.3.6-pl2.tar.gz && cd fftw-3.3.6-pl2 && ./configure && make && make install"
# Install MS-MPI
  - cd ..
  - mkdir C:\projects\deps
  - cd C:\projects\deps
  - ps: (new-object net.webclient).DownloadFile("https://download.microsoft.com/download/D/7/B/D7BBA00F-71B7-436B-80BC-4D22F2EE9862/MSMpiSetup.exe","C:\projects\deps\MSMpiSetup.exe")
  - C:\projects\deps\MSMpiSetup.exe -unattend -minimal
  - set PATH=C:\Program Files\Microsoft MPI\Bin;%PATH%
  - cp "$MSMPI_LIB64/msmpi.lib" .                     # copy msmpi.lib here
  - cp "$WINDIR/system32/msmpi.dll" .                 # copy msmpi.dll here
  - gendef msmpi.dll                                  # generate msmpi.def
  - dlltool -d msmpi.def -D msmpi.dll -l libmsmpi.a   # generate the (static) library file libmsmpi.a
  - cp libmsmpi.a /mingw64/lib                        # copy the new library file to where g++ looks for them;
  - cp "$MSMPI_INC/mpi.h" /mingw64/include            # copy the header file to the default include folder           # copy the header file mpi.h to ~/msmpi/
  - ps: if($env:COMPILER -eq "cygwin") { Invoke-WebRequest $env:cygwin_url -OutFile C:\projects\deps\cygwin-setup.exe }
  - if [%COMPILER%]==[cygwin] C:\projects\deps\cygwin-setup.exe --quiet-mode --no-shortcuts --no-startmenu --no-desktop --upgrade-also --root C:\projects\deps\cygwin --local-package-dir C:\projects\deps\cygwin-downloads --packages gcc-g++,gfortran,openmpi-devel,fftw3-devel
  - cd ..
  - cd C:\projects\ALaDyn

build_script:
  - mkdir build
  - cd build
  - if [%COMPILER%]==[MSYS2] cmake .. -G "MSYS Makefiles"
  - if [%COMPILER%]==[cygwin] cmake .. -G "Unix Makefiles"
  - cmake --build . --target install

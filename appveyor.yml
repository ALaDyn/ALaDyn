environment:
    CYGWIN_NOWINPATH: yes
    matrix:
        - cygwin_url: https://cygwin.com/setup-x86_64.exe
          COMPILER: cygwin
        - COMPILER: msys2
          PLATFORM: x64
          MSYS2_ARCH: x86_64
          MSYS2_DIR: msys64
          MSYSTEM: MINGW64
          BIT: 64

install:
  - call "C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\vcvarsall.bat" amd64
#  - call "C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\VC\Auxiliary\Build\vcvarsall.bat" amd64
  - if [%COMPILER%]==[MSYS2] SET "PATH=C:\%MSYS2_DIR%\%MSYSTEM%\bin;C:\%MSYS2_DIR%\usr\bin;%PATH%"
# Remove C:/Program Files/Git/usr/bin from the path, CMake is incompatible with the sh.exe found inside
  - set PATH=%PATH:C:\Program Files\Git\usr\bin;=%
# Setup pacman (MSYS2 package manager) to enable mirrors and download appropriate toolchain 
  - if [%COMPILER%]==[MSYS2] bash -lc "pacman -S --needed --noconfirm pacman-mirrors"
  - if [%COMPILER%]==[MSYS2] bash -lc "pacman -Syu --noconfirm"
  - if [%COMPILER%]==[MSYS2] bash -lc "pacman -S --needed --noconfirm mingw-w64-x86_64-toolchain make mingw-w64-x86_64-boost"
  - if [%COMPILER%]==[MSYS2] bash -lc "wget http://www.fftw.org/fftw-3.3.6-pl2.tar.gz && tar zxvf fftw-3.3.6-pl2.tar.gz && cd fftw-3.3.6-pl2 && ./configure && make && make install"
# Install MS-MPI
  - cd ..
  - mkdir C:\projects\deps
  - cd C:\projects\deps
  - ps: (new-object net.webclient).DownloadFile("https://download.microsoft.com/download/B/2/E/B2EB83FE-98C2-4156-834A-E1711E6884FB/MSMpiSetup.exe","C:\projects\deps\MSMpiSetup.exe")
  - C:\projects\deps\MSMpiSetup.exe -unattend -minimal
  - set PATH=C:\Program Files\Microsoft MPI\Bin;%PATH%
  - set cmake_38_url="https://cmake.org/files/v3.8/cmake-3.8.0-win32-x86.zip"
  - appveyor DownloadFile %cmake_38_url% -FileName cmake.zip
  - 7z x cmake.zip -oC:\projects\deps > nul
  - move C:\projects\deps\cmake-* C:\projects\deps\cmake
  - set PATH=C:\projects\deps\cmake\bin;%PATH%
  - cmake --version
  - git clone https://github.com/Microsoft/vcpkg
  - cd vcpkg
  - .\bootstrap-vcpkg.bat
  - vcpkg integrate install
  - vcpkg install msmpi
  #still need some fixes!
  #- ps: cp "$MSMPI_LIB64/msmpi.lib" .                 # copy msmpi.lib here
  #- ps: cp "$WINDIR/system32/msmpi.dll" .             # copy msmpi.dll here
  #- gendef msmpi.dll                                  # generate msmpi.def
  #- dlltool -d msmpi.def -D msmpi.dll -l libmsmpi.a   # generate the (static) library file libmsmpi.a
  #- ps: cp libmsmpi.a /mingw64/lib                    # copy the new library file to where g++ looks for them;
  #- ps: cp "$MSMPI_INC/mpi.h" /mingw64/include        # copy the header file to the default include folder           # copy the header file mpi.h to ~/msmpi/
  - ps: if($env:COMPILER -eq "cygwin") { Invoke-WebRequest $env:cygwin_url -OutFile C:\projects\deps\cygwin-setup.exe }
  - if [%COMPILER%]==[cygwin] C:\projects\deps\cygwin-setup.exe --quiet-mode --no-shortcuts --no-startmenu --no-desktop --upgrade-also --root C:\projects\deps\cygwin --local-package-dir C:\projects\deps\cygwin-downloads --packages gcc-g++,gfortran,openmpi-devel,fftw3-devel
  - cd ..
  - cd C:\projects\ALaDyn

build_script:
  - mkdir build
  - cd build
  - if [%COMPILER%]==[MSYS2] cmake .. -G "MSYS Makefiles"
  - if [%COMPILER%]==[cygwin] cmake .. -G "Unix Makefiles"
  - cmake --build . --target install
